This needs to be rewritten, especially to remove async
